<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:b="http://bootsfaces.net/ui"
      xmlns:f="jakarta.faces.core"
      xmlns:h="jakarta.faces.html">

    <body>
        <ui:composition template="./plantilla.xhtml">

            <ui:define name="tituloWeb">Panel de Control</ui:define>

            <ui:define name="contenido">

                <b:carousel id="tiovivo" style="width:100%; margin-bottom: 20px;" interval="3000">
                    <b:carouselItem>
                        <img src="https://placehold.co/1200x300/2c3e50/ffffff?text=Cementerio+La+Paz+-+Tranquilidad+Eterna" 
                             alt="Paisaje 1" style="width: 100%; height: 300px; object-fit: cover;" />
                        <b:carouselCaption>
                            <h3>Sistema de GestiÃ³n Integral</h3>
                            <p>AdministraciÃ³n eficiente de registros y espacios.</p>
                        </b:carouselCaption>
                    </b:carouselItem>
                    <b:carouselItem>
                        <img src="https://placehold.co/1200x300/27ae60/ffffff?text=Amplias+Areas+Verdes+y+Mantenimiento" 
                             alt="Paisaje 2" style="width: 100%; height: 300px; object-fit: cover;" />
                    </b:carouselItem>
                </b:carousel>

                <b:row>
                    <b:column col-md="3" col-sm="6">
                        <b:panel look="primary" collapsible="false">
                            <f:facet name="heading"><i class="fa fa-users"/> Difuntos</f:facet>
                            <h1 style="text-align: center; margin: 0;">#{difuntoBean.listaDifuntos.size()}</h1>
                            <p class="text-center text-muted">Registrados</p>
                        </b:panel>
                    </b:column>

                    <b:column col-md="3" col-sm="6">
                        <b:panel look="success" collapsible="false">
                            <f:facet name="heading"><i class="fa fa-check"/> Disponibles</f:facet>
                            <h1 style="text-align: center; margin: 0;">#{difuntoBean.listaEspaciosDisponibles.size()}</h1>
                            <p class="text-center text-muted">Nichos/Tumbas</p>
                        </b:panel>
                    </b:column>

                    <b:column col-md="3" col-sm="6">
                        <b:panel look="warning" collapsible="false">
                            <f:facet name="heading"><i class="fa fa-clock-o"/> Programados Hoy</f:facet>
                            <h1 style="text-align: center; margin: 0;">2</h1> 
                            <p class="text-center text-muted">Entierros pendientes</p>
                        </b:panel>
                    </b:column>

                    <b:column col-md="3" col-sm="6">
                        <b:panel look="danger" collapsible="false">
                            <f:facet name="heading"><i class="fa fa-tools"/> Mantenimiento</f:facet>
                            <h1 style="text-align: center; margin: 0;">5</h1>
                            <p class="text-center text-muted">Espacios en revisiÃ³n</p>
                        </b:panel>
                    </b:column>
                </b:row>

                <hr/>

                <b:row>
                    <b:column col-md="4">

                        <b:panel title="Acciones RÃ¡pidas" look="info" collapsible="false">
                            <h:form> <div style="display: grid; gap: 10px;">
                                    <b:commandButton value="Nuevo Registro" look="primary" size="lg" icon="plus"
                                                     onclick="$('.modalPseudoClass').modal(); return false;" 
                                                     style="width: 100%"/>

                                    <b:button value="Ver Mapa de Sectores" look="default" icon="map-marker" 
                                              href="mapas.xhtml" style="width: 100%"/>

                                    <b:button value="Reporte Mensual" look="default" icon="file-pdf-o" href="#" style="width: 100%"/>
                                </div>
                            </h:form>
                        </b:panel>

                        <b:panel title="Avisos del Sistema" look="warning" collapsible="true">
                            <b:listLinks>
                                <b:navLink header="Mantenimiento" />
                                <b:navLink value="Sector A cerrado por limpieza" icon="exclamation-triangle" 
                                           onclick="$('.modalAviso').modal(); return false;" />

                                <b:navLink header="Recordatorios" />
                                <b:navLink value="Revisar pagos pendientes" icon="money" 
                                           onclick="$('.modalPagos').modal(); return false;" />
                                <b:navLink value="Actualizar inventario" icon="refresh" href="#" />
                            </b:listLinks>
                        </b:panel>
                    </b:column>

                    <b:column col-md="8">
                        <b:panel title="Ãšltimos Registros" look="primary" collapsible="false">
                            <h:form id="tablaDifuntos">
                                <b:dataTable value="#{difuntoBean.listaDifuntos}" var="difunto" 
                                             excel="true" pdf="true" print="true" responsive="true"
                                             page-length="5" searching="true">

                                    <b:dataTableColumn value="#{difunto.nombre}" label="Nombre"/>

                                    <b:dataTableColumn label="Fecha Def.">
                                        <h:outputText value="#{difunto.fechaDefuncion}" />
                                    </b:dataTableColumn>

                                    <b:dataTableColumn label="UbicaciÃ³n">
                                        <b:label text="#{difunto.espacio.codigo}" severity="info" rendered="#{difunto.espacio != null}"/>
                                        <h:outputText value="--" rendered="#{difunto.espacio == null}" />
                                    </b:dataTableColumn>

                                    <b:dataTableColumn label="AcciÃ³n" orderable="false" style="text-align:center;">
                                        <b:commandButton look="info" icon="eye-open" size="xs" tooltip="Ver"
                                                         action="#{difuntoBean.prepararVista(difunto.id, 'detalle')}" />

                                        <b:commandButton look="warning" icon="edit" size="xs" tooltip="Editar"
                                                         action="#{difuntoBean.prepararVista(difunto.id, 'modificar')}" 
                                                         style="margin-left: 5px"/>

                                        <b:commandButton look="danger" icon="trash" size="xs" tooltip="Borrar"
                                                         action="#{difuntoBean.eliminarDifunto(difunto.id)}" 
                                                         onclick="return confirm('Â¿Eliminar?');" 
                                                         update="@form :formRegistro:msg" style="margin-left: 5px"/> 
                                    </b:dataTableColumn>
                                </b:dataTable>
                            </h:form>
                        </b:panel>

                        <b:accordion expanded-panels="panel1">
                            <b:panel id="panel1" title="Horarios de AtenciÃ³n">
                                <strong>Lunes a Viernes:</strong> 08:00 AM - 06:00 PM <br/>
                                <strong>SÃ¡bados y Domingos:</strong> 09:00 AM - 02:00 PM
                            </b:panel>
                            <b:panel id="panel2" title="Normas del Campo Santo">
                                <p>1. Respetar el silencio.</p>
                                <p>2. No ingresar alimentos.</p>
                            </b:panel>
                        </b:accordion>
                    </b:column>
                </b:row>

                <b:modal id="amodal" title="Registrar Nuevo Difunto" styleClass="modalPseudoClass" closable="false">
                    <h:form id="formRegistro">
                        <b:messages id="msg" showDetail="true" />

                        <b:row>
                            <b:column col-md="6">
                                <b:inputText label="Nombre Completo" value="#{difuntoBean.nuevoDifunto.nombre}" required="true"/>
                            </b:column>
                            <b:column col-md="6">
                                <b:selectOneMenu label="Nacionalidad" value="#{difuntoBean.nuevoDifunto.nacionalidad}">
                                    <f:selectItem itemLabel="Peruana" itemValue="Peruana" />
                                    <f:selectItem itemLabel="Extranjera" itemValue="Extranjera" />
                                </b:selectOneMenu>
                            </b:column>
                        </b:row>

                        <b:row>
                            <b:column col-md="6">
                                <b:selectOneMenu label="UbicaciÃ³n (Espacio)" value="#{difuntoBean.espacioSeleccionadoId}" required="true">
                                    <f:selectItem itemLabel="-- Seleccione --" itemValue="" />
                                    <f:selectItems value="#{difuntoBean.listaEspaciosDisponibles}" 
                                                   var="e" itemLabel="#{e.codigo} (#{e.tipo})" itemValue="#{e.id}" />
                                </b:selectOneMenu>
                            </b:column>
                            <b:column col-md="6">
                                <b:inputText label="Hora (HH:mm)" value="#{difuntoBean.horaEntierro}" placeholder="Ej: 15:30">
                                    <f:convertDateTime type="localTime" pattern="HH:mm"/>
                                </b:inputText>
                            </b:column>
                        </b:row>

                        <b:row>
                            <b:column col-md="6">
                                <b:dateTimePicker label="Nacimiento" value="#{difuntoBean.fechaNac}" format="YYYY-MM-DD" required="true">
                                    <f:convertDateTime type="localDate" pattern="yyyy-MM-dd"/>
                                </b:dateTimePicker>
                            </b:column>
                            <b:column col-md="6">
                                <b:dateTimePicker label="DefunciÃ³n" value="#{difuntoBean.fechaDef}" format="YYYY-MM-DD" required="true">
                                    <f:convertDateTime type="localDate" pattern="yyyy-MM-dd"/>
                                </b:dateTimePicker>
                            </b:column>
                        </b:row>

                        <b:row>
                            <b:column col-md="4">
                                <b:selectOneMenu label="Estado Civil" value="#{difuntoBean.nuevoDifunto.estadoCivil}">
                                    <f:selectItem itemLabel="Soltero/a" itemValue="Soltero/a"/>
                                    <f:selectItem itemLabel="Casado/a" itemValue="Casado/a"/>
                                    <f:selectItem itemLabel="Viudo/a" itemValue="Viudo/a"/>
                                </b:selectOneMenu>
                            </b:column>
                            <b:column col-md="4">
                                <b:inputText label="ReligiÃ³n" value="#{difuntoBean.nuevoDifunto.religion}" />
                            </b:column>
                            <b:column col-md="4">
                                <b:inputText label="Causa DefunciÃ³n" value="#{difuntoBean.nuevoDifunto.causaDefuncion}" />
                            </b:column>
                        </b:row>

                        <div style="text-align: right; margin-top: 20px; border-top: 1px solid #e5e5e5; padding-top: 15px;">
                            <b:button value="Cancelar" dismiss="modal" look="default" />
                            <b:commandButton value="Guardar" look="primary" icon="save" style="margin-left: 10px;"
                                             action="#{difuntoBean.agregarDifunto()}" 
                                             update="@form :tablaDifuntos"
                                             oncomplete="if(!validationFailed) { $('.modalPseudoClass').modal('hide'); }"/>
                        </div>
                    </h:form> 
                </b:modal>

                <b:modal id="modalAviso" title="âš ï¸ Aviso de Mantenimiento" styleClass="modalAviso">
                    <b:row>
                        <b:column col-md="12">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <b:iconAwesome name="exclamation-triangle" size="4x" style="color: #f0ad4e;" />
                            </div>
                            <p><strong>El Sector A (PabellÃ³n Antiguo) se encuentra cerrado temporalmente.</strong></p>
                            <p>Se estÃ¡n realizando labores de limpieza profunda y restauraciÃ³n de veredas.</p>
                            <hr/>
                            <ul style="list-style: none; padding: 0;">
                                <li><strong>ðŸ“… Inicio:</strong> 01 de Diciembre, 2025</li>
                                <li><strong>ðŸ“… Fin estimado:</strong> 05 de Diciembre, 2025</li>
                                <li><strong>â›” Acceso:</strong> Prohibido el paso a visitantes.</li>
                            </ul>
                        </b:column>
                    </b:row>
                    <f:facet name="footer">
                        <b:button value="Entendido" look="primary" dismiss="modal" />
                    </f:facet>
                </b:modal>

                <b:modal id="modalPagos" title="ðŸ’° Estado de Cuenta" styleClass="modalPagos">
                    <b:row>
                        <b:column col-md="12">
                            <b:alert severity="info" rendered="#{not empty pagoBean.listaPagos}">
                                <strong>AtenciÃ³n:</strong> Tiene <strong>#{pagoBean.listaPagos.size()}</strong> pagos pendientes.
                            </b:alert>
                            <b:alert severity="success" rendered="#{empty pagoBean.listaPagos}">
                                <strong>Â¡Excelente!</strong> No tiene deudas pendientes por el momento.
                            </b:alert>

                            <h:form id="formPagos">
                                <b:dataTable value="#{pagoBean.listaPagos}" var="pago" 
                                             searching="false" paginated="false" info="false"
                                             rendered="#{not empty pagoBean.listaPagos}">

                                    <b:dataTableColumn label="Concepto" value="#{pago.concepto}" />
                                    <b:dataTableColumn label="Vence" value="#{pago.vencimiento}" />
                                    <b:dataTableColumn label="Monto">
                                        <h:outputText value="S/ #{pago.monto}" style="color:red; font-weight:bold"/>
                                    </b:dataTableColumn>
                                    <b:dataTableColumn label="AcciÃ³n">
                                        <b:commandButton value="Pagar" look="success" size="xs" icon="credit-card"
                                                         action="#{pagoBean.pagar(pago)}"
                                                         onclick="return confirm('Â¿Confirmar pago?');"
                                                         update="@form" />
                                    </b:dataTableColumn>
                                </b:dataTable>
                            </h:form>
                            <p class="text-muted" style="font-size: 0.9em; margin-top: 10px;">
                                * Los pagos se sincronizan con la base de datos en la nube.
                            </p>
                        </b:column>
                    </b:row>
                    <f:facet name="footer">
                        <b:button value="Cerrar" look="default" dismiss="modal" />
                    </f:facet>
                </b:modal>

            </ui:define>
        </ui:composition>
    </body>
</html>